<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="chronicler">
<title>A non-mathematician's introduction to monads ‚Ä¢ chronicler</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A non-mathematician's introduction to monads">
<meta property="og:description" content="chronicler">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">chronicler</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2.9999</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a-non-mathematician-s-introduction-to-monads.html">A non-mathematician's introduction to monads</a>
    <a class="dropdown-item" href="../articles/a-real-world-example.html">A real world example</a>
    <a class="dropdown-item" href="../articles/developer-vignette-including-the-avia-data-to-the-package.html">Developer Vignette: Including the avia data to the package</a>
    <a class="dropdown-item" href="../articles/the-maybe-monad.html">The Maybe monad</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>A non-mathematician's introduction to monads</h1>
            
      
      
      <div class="d-none name"><code>a-non-mathematician-s-introduction-to-monads.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">chronicler</span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/advanced-topics.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette introduces the functional programming concept of
<em>monad</em>, without going into much technical detail.
<code>{chronicler}</code> is an implementation of a logger monad, but in
truth, it is not necessary to know what monads are to use this package.
However, if you are curious, read on. A monad is a computation device
that offers two things:</p>
<ul>
<li>the possibility to decorate functions so they can provide additional
output without having to touch the function‚Äôs core implementation;</li>
<li>a way to compose these decorated functions;</li>
</ul>
<p>(This definition is an oversimplification of the actual definition of
a monad, but good enough for our purposes.)</p>
<p>To understand what a monad is, I believe it is useful to explain what
sort of problem monads solve.</p>
<p>Suppose for instance that you wish for your functions to provide a
log when they‚Äôre run. If your function looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_sqrt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then you would need to rewrite this function like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_sqrt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">log</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">log</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Running sqrt with input "</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are two problems with such an implementation:</p>
<ul>
<li>we need to rewrite every function we need to use so that they
provide logs;</li>
<li>these functions don‚Äôt compose.</li>
</ul>
<p>What do I mean with ‚Äúthese functions don‚Äôt compose‚Äù? Consider another
such function <code>my_log()</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_log</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">log</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">log</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Running log with input "</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt()</a></code> and <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log()</a></code> compose, or rather, they
can be chained:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span></code></pre></div>
<p>while this is not true for <code>my_sqrt()</code> and
<code>my_log()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">my_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">my_log</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>Error in log(x) (from #3) : non-numeric argument to mathematical function</code></pre>
<p>This is because <code>my_log()</code> expects a number, not a list
which is what <code>my_sqrt()</code> returns.</p>
<p>A ‚Äúmonad‚Äù is what we need to solve these two problems. The first
problem, not having to rewrite every function, can be tackled using <a href="https://adv-r.hadley.nz/function-factories.html" class="external-link">function
factories</a>. Let‚Äôs write one for our problem:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_it</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.f</span>, <span class="va">...</span>, <span class="va">log</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">fstring</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">.f</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">.log</span> <span class="op">=</span> <span class="va">log</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">.f</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>         log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.log</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Running "</span>, <span class="va">fstring</span>, <span class="st">" with argument "</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can now create our functions easily:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_sqrt</span> <span class="op">&lt;-</span> <span class="fu">log_it</span><span class="op">(</span><span class="va">sqrt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">l_sqrt</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 3.162278</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running sqrt with argument 10"</span></span>
<span></span>
<span><span class="va">l_log</span> <span class="op">&lt;-</span> <span class="fu">log_it</span><span class="op">(</span><span class="va">log</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">l_log</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 2.302585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running log with argument 10"</span></span></code></pre></div>
<p>We can call <code>l_sqrt()</code> and <code>l_log()</code>
<em>decorated</em> functions and the values they return <em>monadic</em>
values.</p>
<p>The second issue remains though; <code>l_sqrt()</code> and
<code>l_log()</code> can‚Äôt be composed/chained. To solve this issue, we
need another function, called <code>bind()</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bind</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.l</span>, <span class="va">.f</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu">.f</span><span class="op">(</span><span class="va">.l</span><span class="op">$</span><span class="va">result</span>, <span class="va">...</span>, .log <span class="op">=</span> <span class="va">.l</span><span class="op">$</span><span class="va">log</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Using <code>bind()</code>, it is now possible to compose
<code>l_sqrt()</code> and <code>l_log()</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">l_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">bind</span><span class="op">(</span><span class="va">l_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running sqrt with argument 10"             </span></span>
<span><span class="co">#&gt; [2] "Running log with argument 3.16227766016838"</span></span></code></pre></div>
<p><code>bind()</code> takes care of providing the right arguments to
the underlying function. We can check that the result is correct by
comparing it the <code>$result</code> value from the returned object to
<code>log(sqrt(10))</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span></code></pre></div>
<p>This solution of using a function factory and defining a helper
function to make the decorated functions compose is what constitutes a
monad, but strictly speaking, this is not precisely correct. It can be
interesting to see the actual definition from the programming language
Haskell, which is a pure functional programming language where monads
<em>must</em> be used to solve certain issues:</p>
<em>Monads can be viewed as a standard programming interface to various
data or control structures, which is captured by Haskell‚Äôs
<code>Monad</code> class. All the common monads are members of it:</em>
<div class="mw-highlight mw-content-ltr" dir="ltr">
<pre><span class="kr">class</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="kr">where</span>
  <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span>  <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span>  <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
  <span class="p">(</span><span class="o">&gt;&gt;</span><span class="p">)</span>   <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span>  <span class="n">m</span> <span class="n">b</span>         <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
  <span class="n">return</span> <span class="ow">::</span>   <span class="n">a</span>                 <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
</pre>
</div>
<p>(Source: <a href="https://wiki.haskell.org/Monad" class="external-link">Monad</a>)</p>
<p>This definition is quite cryptic, especially if you don‚Äôt know
Haskell, but what this means is that a <code>Monad</code> (in Haskell)
is <em>something</em> that has three methods:</p>
<ul>
<li>
<code>&gt;&gt;=</code> which is what we called
<code>bind()</code>;</li>
<li>
<code>&gt;&gt;</code> which I didn‚Äôt bother implementing, because
it‚Äôs not really needed for understanding what a monad is;</li>
<li>and <code>return</code>. Don‚Äôt be confused by the name, this has
nothing to do with the <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> we use inside functions to
return a value. <code>return</code> is a function that wraps (or
converts) a value into a monadic value, so if you consider any object
<code>a</code>, <code>return</code> takes <code>a</code> as an input and
<em>returns</em> the monadic value <code>m a</code>.</li>
</ul>
<p>While we didn‚Äôt implement <code>return</code> (also called
<code>unit</code>, which is also not a good name), our function factory
<code>log_it()</code> does <code>return</code>/<code>unit</code>‚Äôs job
but it <em>returns</em> <code>m f(a)</code> instead of <code>m a</code>.
Using function factories comes more naturally to R users than using
<code>return</code>/<code>unit</code>, hence why I did not focus on
<code>return</code>/<code>unit</code>. Also, using our function factory,
it is easy to implement <code>return/unit</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unit</span> <span class="op">&lt;-</span> <span class="fu">log_it</span><span class="op">(</span><span class="va">identity</span><span class="op">)</span></span></code></pre></div>
<p>so <code>return/unit</code> is just the <code><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity()</a></code>
function that went through the function factory. In a sense, the
function factory is even more necessary for defining a monad than
<code>return/unit</code>.</p>
<p>Finally, you might read sometimes that monads are objects that have a
<code>flatmap()</code> method. I think that this definition as well is
not strictly correct and very likely an oversimplification. But what is
<code>flatmap()</code> anyways? In practical terms, it is equivalent to
<code>bind()</code>, but it is how you get there that‚Äôs different. To
implement <code>flatmap()</code> two additional functions are needed:
<code>fmap()</code> and <code>flatten()</code> (which is quite often
called <code>join()</code>, but this has nothing to do with
<em>joining</em> data frames, so I used <code>flatten()</code>
instead).</p>
<p><code>fmap()</code> is a function that takes a monadic value as an
argument and an undecorated function and applies this undecorated
function to the monadic value:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fmap</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">f</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">fstring</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">result</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>       log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">log</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fmapping "</span>, <span class="va">fstring</span>, <span class="st">" with arguments "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">result</span>, <span class="va">...</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let‚Äôs first define a monadic value:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let‚Äôs use unit(), which we defined above, for this.</span></span>
<span></span>
<span><span class="op">(</span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running identity with argument 10"</span></span></code></pre></div>
<p>Let‚Äôs now use <code>fmap()</code> to apply a non-decorated function
to <code>m</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fmap</span><span class="op">(</span><span class="va">m</span>, <span class="va">log</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 2.302585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running identity with argument 10" "fmapping log with arguments 10"</span></span></code></pre></div>
<p>Great, now what about <code>flatten()</code> (or
<code>join()</code>)? Why is that useful? Suppose that instead of
<code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log()</a></code> we used <code>l_log()</code> with <code>fmap()</code>
(so we‚Äôre using a decorated function instead of an undecorated one):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fmap</span><span class="op">(</span><span class="va">m</span>, <span class="va">l_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; $result$result</span></span>
<span><span class="co">#&gt; [1] 2.302585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $result$log</span></span>
<span><span class="co">#&gt; [1] "Running log with argument 10"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running identity with argument 10" "fmapping l_log with arguments 10"</span></span></code></pre></div>
<p>As you can see from the output, this produced a nested list, a
monadic value where the value is itself a monadic value. We would like
<code>flatten()/join()</code> to take care of this for us. So this could
be an implementation of <code>flatten()</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flatten</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>result <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">result</span><span class="op">$</span><span class="va">result</span>,</span>
<span>       log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">log</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let‚Äôs try now:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">flatten</span><span class="op">(</span><span class="fu">fmap</span><span class="op">(</span><span class="va">m</span>, <span class="va">l_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 2.302585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running identity with argument 10" "fmapping l_log with arguments 10"</span></span></code></pre></div>
<p>Great! Now, as explained earlier, <code>flatmap()</code> and
<code>bind()</code> are the same thing. But we have implemented
<code>flatten()</code> and <code>fmap()</code>, so how do these two
functions relate to <code>flatmap()</code>? It turns out that
<code>flatmap()</code> is the composition of <code>flatten()</code> and
<code>fmap()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># I first define a composition operator for functions</span></span>
<span><span class="va">`%.%`</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">f</span>,<span class="va">g</span><span class="op">)</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="fu">g</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># I now compose flatten() and fmap()</span></span>
<span><span class="co"># flatten %.% fmap is read as "flatten after fmap"</span></span>
<span><span class="va">flatmap</span> <span class="op">&lt;-</span> <span class="va">flatten</span> <span class="op">%.%</span> <span class="va">fmap</span></span></code></pre></div>
<p>So this means that we can now replace:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">l_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">bind</span><span class="op">(</span><span class="va">l_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running sqrt with argument 10"             </span></span>
<span><span class="co">#&gt; [2] "Running log with argument 3.16227766016838"</span></span></code></pre></div>
<p>by:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">l_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">flatmap</span><span class="op">(</span><span class="va">l_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; $result</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log</span></span>
<span><span class="co">#&gt; [1] "Running sqrt with argument 10"                 </span></span>
<span><span class="co">#&gt; [2] "fmapping l_log with arguments 3.16227766016838"</span></span></code></pre></div>
<p>and we get the same result (well, not quite, since the log is
different). I prefer introducing monads using <code>bind()</code>,
because <code>bind()</code> comes as a natural solution to the problem
of decorated functions not composing. Not so with
<code>flatmap()</code>, but in some applications it might be easier to
first define <code>flatten()</code> and <code>join()</code> and get
<code>flatmap()</code> instead of trying to write <code>bind()</code>
directly, so it‚Äôs good to know both approaches.</p>
<p>Before continuing with the final part of this introduction, I just
want to share with you that lists are also monads. We have everything we
need: <code><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list()</a></code> is <code><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit()</a></code>,
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code> is <code>fmap()</code> and
<code>purrr::flatten()</code> is <code>flatten()</code>. This means we
can obtain <code>flatmap()</code> from composing
<code>purrr::flatten()</code> and <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Since I'm using `{purrr}`, might as well use purrr::compose() instead of my own implementation</span></span>
<span><span class="va">flatmap_list</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/compose.html" class="external-link">compose</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="va">flatten</span>, <span class="fu">purrr</span><span class="fu">::</span><span class="va"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Functions that return lists: they don't compose!</span></span>
<span><span class="co"># no worries, we implemented `flatmap_list()`</span></span>
<span><span class="va">list_sqrt</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">list_log</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">list_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">flatmap_list</span><span class="op">(</span><span class="va">list_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 1.151293</span></span></code></pre></div>
<p>(thanks to <a href="https://twitter.com/armcn_/status/1511705262935011330?s=20&amp;t=UfwIjsqyOX7-UbTMBHOCuw" class="external-link"><span class="citation">@armcn_</span></a> for showing me this)</p>
<p>In sum, monads are useful when you need values to also carry
something more with them. This <em>something</em> can be a log, as shown
here, but there are many examples. For another example of a monad
implemented as an R package, see the <a href="https://armcn.github.io/maybe/" class="external-link">maybe monad</a>.
<code>{chronicle}</code> actually takes advantage of the
<a href="https://github.com/armcn/maybe" class="external-link">maybe</a> package and uses the maybe monad to handle cases
where functions fail. I provide a short introduction to the maybe monad
in the <a href="https://b-rodrigues.github.io/chronicler/articles/maybe-monad.html">Maybe
monad vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="monadic-laws">Monadic laws<a class="anchor" aria-label="anchor" href="#monadic-laws"></a>
</h2>
<p>Monads need to satisfy the so-called ‚Äúmonadic laws‚Äù. We‚Äôre going to
verify if the monad implemented in <code>{chronicler}</code> satisfies
these monadic laws.</p>
<div class="section level3">
<h3 id="first-law">First law<a class="anchor" aria-label="anchor" href="#first-law"></a>
</h3>
<p>The first law states that passing a monadic value to a monadic
function using <code>bind()</code> (or in the case of the
<code>{chronicler}</code> package <code><a href="../reference/bind_record.html">bind_record()</a></code>) or passing
a value to a monadic function is the same.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_chronicle.html">as_chronicle</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">r_sqrt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">sqrt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"first monadic law"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">r_sqrt</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>, <span class="fu">r_sqrt</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> üò∏</span></span></code></pre></div>
<p>Turns out that this is not quite the case here; the logs of the two
objects will be slightly different. So I only check the value.</p>
</div>
<div class="section level3">
<h3 id="second-law">Second law<a class="anchor" aria-label="anchor" href="#second-law"></a>
</h3>
<p>The second law states that binding a monadic value to
<code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> (called <code><a href="../reference/as_chronicle.html">as_chronicle()</a></code> in this
package, in other words, the function that coerces values to chronicler
objects) does nothing. Here again we have an issue with the log, that‚Äôs
why I focus on the value:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"second monadic law"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">as_chronicle</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>, <span class="va">a</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> üéâ</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="third-law">Third law<a class="anchor" aria-label="anchor" href="#third-law"></a>
</h3>
<p>The third law is about associativity; applying monadic functions
successively or composing them first gives the same result.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_chronicle.html">as_chronicle</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r_sqrt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">sqrt</span><span class="op">)</span></span>
<span><span class="va">r_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span></span>
<span><span class="va">r_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"third monadic law"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span></span>
<span>  <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">r_sqrt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">r_exp</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">value</span>,</span>
<span>  <span class="op">(</span></span>
<span>    <span class="va">a</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">r_sqrt</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">r_exp</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ü•≥</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="flatmap-for-chronicle-objects">flatmap() for <code>chronicle</code> objects<a class="anchor" aria-label="anchor" href="#flatmap-for-chronicle-objects"></a>
</h2>
<p>For exhaustivity‚Äôs sake, I check that I can get
<code>flatmap_record()</code> by composing <code><a href="../reference/flatten_record.html">flatten_record()</a></code>
and <code><a href="../reference/fmap_record.html">fmap_record()</a></code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">r_sqrt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">sqrt</span><span class="op">)</span></span>
<span><span class="va">r_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">exp</span><span class="op">)</span></span>
<span><span class="va">r_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/record.html">record</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">r_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">r_exp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/bind_record.html">bind_record</a></span><span class="op">(</span><span class="va">r_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flatmap_record</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/compose.html" class="external-link">compose</a></span><span class="op">(</span><span class="va">flatten_record</span>, <span class="va">fmap_record</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">r_sqrt</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">flatmap_record</span><span class="op">(</span><span class="va">r_exp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">flatmap_record</span><span class="op">(</span><span class="va">r_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">a</span><span class="op">$</span><span class="va">value</span>, <span class="va">b</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bruno Rodrigues.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
